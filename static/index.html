<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Air Quality Monitor - Hourly Samples</title>
    <!-- –õ–æ–∫–∞–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (—Ä–∞–±–æ—Ç–∞—é—Ç –±–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞) -->
    <link href="/static/bootstrap.min.css" rel="stylesheet">
    <link href="/static/all.min.css" rel="stylesheet">
    <script src="/static/chart.js"></script>
    <script src="/static/socket.io.min.js"></script>
    <style>
        :root {
            --good: #4CAF50;
            --moderate: #FFC107;
            --unhealthy: #FF9800;
            --hazardous: #F44336;
            --severe: #9C27B0;
        }

        body {
            background: #f5f5f5;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding-bottom: 60px;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .card {
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border: none;
            margin-bottom: 20px;
            transition: transform 0.3s, box-shadow 0.3s;
            background: white;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .value-large {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 10px 0;
            line-height: 1.2;
        }
        
        .quality-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            display: inline-block;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }
        
        .connected { background-color: var(--good); box-shadow: 0 0 10px var(--good); }
        .disconnected { background-color: var(--hazardous); box-shadow: 0 0 10px var(--hazardous); }
        .waiting { background-color: var(--moderate); box-shadow: 0 0 10px var(--moderate); }
        
        .sample-time {
            font-size: 0.85rem;
            color: #666;
            margin-top: 5px;
        }
        
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            height: 400px;
            position: relative;
        }
        
        .aqi-legend {
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
            display: inline-block;
        }
        
        .hourly-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .countdown-box {
            background: rgba(102, 126, 234, 0.1);
            padding: 10px 20px;
            border-radius: 50px;
            display: inline-block;
            font-weight: 600;
        }

        #countdownTimer {
            font-size: 1.2rem;
            color: #667eea;
            font-family: monospace;
        }

        .stat-box {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            height: 100%;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
        }

        .table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
        }

        .table td {
            vertical-align: middle;
        }

        .footer {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: white;
            padding: 10px 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            z-index: 1000;
        }

        @media (max-width: 768px) {
            .value-large {
                font-size: 1.8rem;
            }
            
            .card {
                margin-bottom: 15px;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .chart-container {
                height: 300px;
            }
            
            .stat-box {
                margin-bottom: 10px;
            }
            
            .col-md-2, .col-sm-4 {
                margin-bottom: 10px;
            }
            
            .countdown-box {
                padding: 8px 15px;
                font-size: 0.9rem;
            }
            
            #countdownTimer {
                font-size: 1rem;
            }
        }

        @media (max-width: 576px) {
            .value-large {
                font-size: 1.5rem;
            }
            
            .header {
                padding: 15px 0;
            }
            
            .table {
                font-size: 0.8rem;
            }
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö */
        @keyframes highlight {
            0% { background-color: rgba(102, 126, 234, 0.2); }
            100% { background-color: transparent; }
        }

        .highlight {
            animation: highlight 2s ease-out;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–∫—Ä–æ–ª–ª–∞ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="fas fa-wind"></i> Air Quality Monitor</h1>
                    <p class="lead mb-0">Real-time monitoring with <span class="hourly-badge"><i class="far fa-clock"></i> 1-hour sampling intervals</span></p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="d-inline-block bg-white text-dark rounded-pill px-3 py-2 shadow-sm">
                        <span class="status-indicator" id="statusIndicator"></span>
                        <span id="connectionStatus" class="fw-bold">Connecting...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- –°—Ç–∞—Ç—É—Å –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h5 class="card-title">
                                    <i class="fas fa-info-circle text-primary"></i> System Status
                                </h5>
                                <p class="card-text" id="statusMessage">
                                    <i class="fas fa-spinner fa-spin"></i> Initializing system...
                                </p>
                                <div class="mt-2">
                                    <span class="badge bg-light text-dark me-2">
                                        <i class="far fa-calendar-alt"></i> <span id="currentDate"></span>
                                    </span>
                                    <span class="badge bg-light text-dark">
                                        <i class="far fa-clock"></i> <span id="currentTime"></span>
                                    </span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="row">
                                    <div class="col-6">
                                        <div class="stat-box">
                                            <div class="stat-label">Next Sample In</div>
                                            <div class="stat-value" id="countdownTimer">--:--:--</div>
                                            <small class="text-muted" id="samplesCollected">0 samples</small>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="stat-box">
                                            <div class="stat-label">Last Update</div>
                                            <div class="stat-value" id="lastUpdateTime">--:--:--</div>
                                            <small class="text-muted">Hourly average</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –¢–µ–∫—É—â–µ–µ —á–∞—Å–æ–≤–æ–µ —Å—Ä–µ–¥–Ω–µ–µ -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex align-items-center mb-3">
                    <h4 class="mb-0 me-3"><i class="fas fa-chart-bar text-primary"></i> Current Hourly Average</h4>
                    <span class="badge bg-primary rounded-pill px-3 py-2">
                        <i class="far fa-hourglass"></i> <span id="sampleCount">0</span> samples
                    </span>
                </div>
                
                <div class="card">
                    <div class="card-body">
                        <div class="row text-center g-3">
                            <!-- PM2.5 -->
                            <div class="col-lg-2 col-md-4 col-sm-6">
                                <div class="p-3 bg-light rounded-3 h-100">
                                    <div class="text-muted small mb-2">
                                        <i class="fas fa-microscope"></i> PM2.5
                                    </div>
                                    <div class="value-large" id="pm25Value">--</div>
                                    <div class="unit text-muted mb-2">¬µg/m¬≥</div>
                                    <div id="pm25Quality" class="quality-badge w-100">--</div>
                                </div>
                            </div>
                            
                            <!-- AQI -->
                            <div class="col-lg-2 col-md-4 col-sm-6">
                                <div class="p-3 bg-light rounded-3 h-100">
                                    <div class="text-muted small mb-2">
                                        <i class="fas fa-chart-line"></i> AQI
                                    </div>
                                    <div class="value-large" id="aqiValue">--</div>
                                    <div class="unit text-muted mb-2">Index</div>
                                    <div id="aqiQuality" class="quality-badge w-100">--</div>
                                </div>
                            </div>
                            
                            <!-- –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ -->
                            <div class="col-lg-2 col-md-4 col-sm-6">
                                <div class="p-3 bg-light rounded-3 h-100">
                                    <div class="text-muted small mb-2">
                                        <i class="fas fa-thermometer-half"></i> Temperature
                                    </div>
                                    <div class="value-large" id="tempValue">--</div>
                                    <div class="unit text-muted">¬∞C</div>
                                </div>
                            </div>
                            
                            <!-- –í–ª–∞–∂–Ω–æ—Å—Ç—å -->
                            <div class="col-lg-2 col-md-4 col-sm-6">
                                <div class="p-3 bg-light rounded-3 h-100">
                                    <div class="text-muted small mb-2">
                                        <i class="fas fa-tint"></i> Humidity
                                    </div>
                                    <div class="value-large" id="humValue">--</div>
                                    <div class="unit text-muted">%</div>
                                </div>
                            </div>
                            
                            <!-- PM1.0 -->
                            <div class="col-lg-2 col-md-4 col-sm-6">
                                <div class="p-3 bg-light rounded-3 h-100">
                                    <div class="text-muted small mb-2">
                                        <i class="fas fa-biohazard"></i> PM1.0
                                    </div>
                                    <div class="value-large" id="pm1Value">--</div>
                                    <div class="unit text-muted">¬µg/m¬≥</div>
                                </div>
                            </div>
                            
                            <!-- PM10 -->
                            <div class="col-lg-2 col-md-4 col-sm-6">
                                <div class="p-3 bg-light rounded-3 h-100">
                                    <div class="text-muted small mb-2">
                                        <i class="fas fa-wind"></i> PM10
                                    </div>
                                    <div class="value-large" id="pm10Value">--</div>
                                    <div class="unit text-muted">¬µg/m¬≥</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="alert alert-info mb-0 d-flex align-items-center">
                                    <i class="fas fa-info-circle fa-2x me-3"></i>
                                    <div>
                                        <strong>Hourly Average Data</strong><br>
                                        This data represents the average of all measurements taken over the last hour.
                                        <span class="badge bg-primary ms-2" id="sampleCountText">0 samples used</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
        <div class="row mb-4">
            <div class="col-lg-6 mb-4">
                <div class="chart-container">
                    <h5 class="mb-3"><i class="fas fa-chart-line text-primary"></i> PM2.5 Trend (7 Days)</h5>
                    <canvas id="pm25Chart" style="height: calc(100% - 40px); width: 100%;"></canvas>
                </div>
            </div>
            <div class="col-lg-6 mb-4">
                <div class="chart-container">
                    <h5 class="mb-3"><i class="fas fa-thermometer-half text-danger"></i> Temperature & Humidity</h5>
                    <canvas id="tempHumChart" style="height: calc(100% - 40px); width: 100%;"></canvas>
                </div>
            </div>
        </div>

        <!-- –¢–∞–±–ª–∏—Ü–∞ –¥–∞–Ω–Ω—ã—Ö -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-white py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-table text-primary"></i> Recent Hourly Samples</h5>
                            <div>
                                <button class="btn btn-sm btn-outline-primary me-2" onclick="refreshData()">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                                <button class="btn btn-sm btn-success" onclick="exportData()">
                                    <i class="fas fa-download"></i> Export CSV
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Time</th>
                                        <th>Date</th>
                                        <th>PM2.5</th>
                                        <th>AQI</th>
                                        <th>Quality</th>
                                        <th>Temp</th>
                                        <th>Humidity</th>
                                        <th>Samples</th>
                                    </tr>
                                </thead>
                                <tbody id="dataTable">
                                    <tr>
                                        <td colspan="8" class="text-center py-4">
                                            <i class="fas fa-spinner fa-spin me-2"></i>Loading data...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –õ–µ–≥–µ–Ω–¥–∞ AQI -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h6 class="mb-3"><i class="fas fa-palette"></i> Air Quality Index (AQI) Scale</h6>
                        <div class="row g-2">
                            <div class="col-md-3 col-6">
                                <div class="p-3 rounded text-center" style="background-color: var(--good); color: white;">
                                    <strong>Good</strong><br>
                                    <small>0-50</small>
                                </div>
                            </div>
                            <div class="col-md-3 col-6">
                                <div class="p-3 rounded text-center" style="background-color: var(--moderate); color: black;">
                                    <strong>Moderate</strong><br>
                                    <small>51-100</small>
                                </div>
                            </div>
                            <div class="col-md-3 col-6">
                                <div class="p-3 rounded text-center" style="background-color: var(--unhealthy); color: white;">
                                    <strong>Unhealthy</strong><br>
                                    <small>101-150</small>
                                </div>
                            </div>
                            <div class="col-md-3 col-6">
                                <div class="p-3 rounded text-center" style="background-color: var(--hazardous); color: white;">
                                    <strong>Hazardous</strong><br>
                                    <small>151+</small>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3 text-muted small">
                            <i class="fas fa-info-circle"></i> AQI calculated from PM2.5 using US EPA standard
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="container text-center">
            <small class="text-muted">
                <i class="fas fa-microchip me-1"></i>Air Quality Monitor ‚Ä¢ 
                <span id="totalReadings">0</span> total readings ‚Ä¢ 
                <span id="totalHours">0</span> hours of data
            </small>
        </div>
    </footer>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let socket;
        let pm25Chart;
        let tempHumChart;
        let countdownInterval;
        let lastHourlyTimestamp = null;
        let historicalData = [];
        
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞—Ç–æ–π –∏ –≤—Ä–µ–º–µ–Ω–µ–º
        function updateDateTime() {
            const now = new Date();
            document.getElementById('currentDate').textContent = now.toLocaleDateString('ru-RU', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('ru-RU', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WebSocket
        function initWebSocket() {
            socket = io({
                transports: ['websocket'],
                upgrade: false,
                reconnection: true,
                reconnectionAttempts: Infinity,
                reconnectionDelay: 1000,
                reconnectionDelayMax: 5000,
                timeout: 20000
            });
            
            socket.on('connect', function() {
                console.log('‚úÖ Connected to server');
                updateConnectionStatus('connected', 'Connected to server');
                updateProgress();
                loadHistoricalData();
                loadLongTermStats();
            });
            
            socket.on('connect_error', function(error) {
                console.log('‚ùå Connection error:', error);
                updateConnectionStatus('disconnected', 'Connection error - retrying...');
            });
            
            socket.on('disconnect', function() {
                console.log('üîå Disconnected from server');
                updateConnectionStatus('disconnected', 'Disconnected from server');
            });
            
            socket.on('sensor_data', function(data) {
                updateCurrentData(data);
            });
            
            socket.on('hourly_sample', function(data) {
                console.log('üìä New hourly sample:', data);
                updateHourlySample(data);
                lastHourlyTimestamp = new Date(data.timestamp);
                loadHistoricalData(); // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫–∏
                loadLongTermStats(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            });
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        function updateConnectionStatus(status, message) {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('connectionStatus');
            const statusMessage = document.getElementById('statusMessage');
            
            // –£–¥–∞–ª—è–µ–º –≤—Å–µ –∫–ª–∞—Å—Å—ã —Å—Ç–∞—Ç—É—Å–∞
            indicator.className = 'status-indicator ' + status;
            statusText.textContent = status === 'connected' ? 'Connected' : 
                                   status === 'waiting' ? 'Waiting for Arduino' : 'Disconnected';
            
            if (message) {
                statusMessage.innerHTML = `<i class="fas fa-${status === 'connected' ? 'check-circle' : 'exclamation-circle'} me-2"></i>${message}`;
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö
        function updateCurrentData(data) {
            document.getElementById('lastUpdateTime').textContent = data.time || new Date().toLocaleTimeString();
            
            if (!data.is_hourly_sample) {
                const statusMessage = document.getElementById('statusMessage');
                if (data.status === 'waiting_for_arduino') {
                    statusMessage.innerHTML = `<i class="fas fa-hourglass-half me-2"></i>${data.message}`;
                    updateConnectionStatus('waiting', data.message);
                } else {
                    statusMessage.innerHTML = `<i class="fas fa-database me-2"></i>Collecting data... ${data.accumulated_count || 0} raw samples collected`;
                    updateConnectionStatus('connected', 'Receiving data from Arduino');
                }
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∞—Å–æ–≤–æ–π –≤—ã–±–æ—Ä–∫–∏
        function updateHourlySample(data) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è
            document.getElementById('pm25Value').textContent = formatValue(data.pm25, 1);
            document.getElementById('aqiValue').textContent = data.aqi || '--';
            document.getElementById('tempValue').textContent = formatValue(data.temperature, 1);
            document.getElementById('humValue').textContent = formatValue(data.humidity, 1);
            document.getElementById('pm1Value').textContent = formatValue(data.pm1, 1);
            document.getElementById('pm10Value').textContent = formatValue(data.pm10, 1);
            document.getElementById('sampleCount').textContent = data.sample_count || 0;
            document.getElementById('sampleCountText').textContent = `${data.sample_count || 0} samples used`;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—á–µ—Å—Ç–≤–æ –≤–æ–∑–¥—É—Ö–∞
            const pm25Quality = document.getElementById('pm25Quality');
            const aqiQuality = document.getElementById('aqiQuality');
            
            if (data.quality) {
                pm25Quality.textContent = data.quality;
                aqiQuality.textContent = data.quality;
                
                const color = getColorFromAQI(data.aqi);
                pm25Quality.style.backgroundColor = color;
                aqiQuality.style.backgroundColor = color;
                pm25Quality.style.color = getTextColor(data.aqi);
                aqiQuality.style.color = getTextColor(data.aqi);
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è
            document.getElementById('lastUpdateTime').textContent = data.time || new Date().toLocaleTimeString();
            document.getElementById('statusMessage').innerHTML = 
                `<i class="fas fa-check-circle text-success me-2"></i>Hourly sample collected (${data.sample_count || 0} samples)`;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
            document.querySelector('.card').classList.add('highlight');
            setTimeout(() => {
                document.querySelector('.card').classList.remove('highlight');
            }, 2000);
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π
        function formatValue(value, decimals) {
            if (value === null || value === undefined || value === '--') return '--';
            return Number(value).toFixed(decimals);
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞ –¥–ª—è AQI
        function getColorFromAQI(aqi) {
            if (!aqi || aqi === '--') return '#666';
            if (aqi <= 50) return 'var(--good)';
            if (aqi <= 100) return 'var(--moderate)';
            if (aqi <= 150) return 'var(--unhealthy)';
            if (aqi <= 200) return 'var(--hazardous)';
            return 'var(--severe)';
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è AQI
        function getTextColor(aqi) {
            if (!aqi || aqi === '--') return 'white';
            return aqi <= 100 ? 'black' : 'white';
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        function updateProgress() {
            fetch('/api/current_progress')
                .then(response => response.json())
                .then(data => {
                    const totalSeconds = data.remaining || 3600;
                    const hours = Math.floor(totalSeconds / 3600);
                    const minutes = Math.floor((totalSeconds % 3600) / 60);
                    const seconds = Math.floor(totalSeconds % 60);
                    
                    document.getElementById('countdownTimer').textContent = 
                        `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    
                    document.getElementById('samplesCollected').textContent = 
                        `${data.samples_collected || 0} samples`;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ —Å–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                    const statusMessage = document.getElementById('statusMessage');
                    if (statusMessage && data.samples_collected > 0 && !statusMessage.innerHTML.includes('‚úÖ')) {
                        const progress = data.progress || 0;
                        statusMessage.innerHTML = `<i class="fas fa-spinner fa-pulse me-2"></i>Collecting data... ${data.samples_collected} samples (${progress}% of hour)`;
                    }
                })
                .catch(error => {
                    console.error('Error fetching progress:', error);
                });
        }

        // –ó–∞–ø—É—Å–∫ —Ç–∞–π–º–µ—Ä–∞
        function startCountdownTimer() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            countdownInterval = setInterval(updateProgress, 1000);
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
        function loadHistoricalData() {
            fetch('/api/hourly_samples?hours=168')
                .then(response => response.json())
                .then(data => {
                    historicalData = data;
                    updateDataTable(data);
                    updateChartsWithHistoricalData(data);
                    
                    // –ï—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ, –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —á–∞—Å–æ–≤–æ–π –ø–æ–∫–∞–∑
                    if (data && data.length > 0) {
                        const latest = data[0];
                        const quality = getAQILevel(latest.aqi);
                        updateHourlySample({
                            timestamp: latest.timestamp,
                            pm25: latest.pm25,
                            pm1: latest.pm1,
                            pm10: latest.pm10,
                            temperature: latest.temperature,
                            humidity: latest.humidity,
                            aqi: latest.aqi,
                            quality: quality,
                            sample_count: latest.sample_count,
                            time: new Date(latest.timestamp).toLocaleTimeString()
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading historical data:', error);
                });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function loadLongTermStats() {
            fetch('/api/long_term_stats')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('totalReadings').textContent = data.total_readings || 0;
                    document.getElementById('totalHours').textContent = data.total_hours || 0;
                })
                .catch(error => {
                    console.error('Error loading stats:', error);
                });
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –¥–∞–Ω–Ω—ã—Ö
        function updateDataTable(data) {
            const tbody = document.getElementById('dataTable');
            tbody.innerHTML = '';
            
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4">üìä No data available yet</td></tr>';
                return;
            }
            
            data.slice(0, 24).forEach((item, index) => {
                const row = document.createElement('tr');
                if (index === 0) row.classList.add('table-primary');
                
                const timestamp = new Date(item.timestamp);
                const timeStr = timestamp.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
                const dateStr = timestamp.toLocaleDateString();
                
                const aqi = item.aqi || '--';
                const qualityText = getAQILevel(aqi);
                const qualityColor = getColorFromAQI(aqi);
                const textColor = getTextColor(aqi);
                
                row.innerHTML = `
                    <td><strong>${timeStr}</strong></td>
                    <td>${dateStr}</td>
                    <td><strong>${item.pm25 !== null ? item.pm25.toFixed(1) : '--'}</strong></td>
                    <td><strong class="${aqi !== '--' ? 'fw-bold' : ''}">${aqi}</strong></td>
                    <td>
                        <span class="badge" style="background-color: ${qualityColor}; color: ${textColor}; padding: 5px 10px;">
                            ${qualityText}
                        </span>
                    </td>
                    <td>${item.temperature !== null ? item.temperature.toFixed(1) : '--'}</td>
                    <td>${item.humidity !== null ? item.humidity.toFixed(1) : '--'}</td>
                    <td><span class="badge bg-secondary">${item.sample_count || 1}</span></td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è AQI
        function getAQILevel(aqi) {
            if (aqi === '--' || aqi === null || aqi === undefined) return 'Unknown';
            if (aqi <= 50) return 'Good';
            if (aqi <= 100) return 'Moderate';
            if (aqi <= 150) return 'Unhealthy';
            if (aqi <= 200) return 'Very Unhealthy';
            return 'Hazardous';
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤ —Å –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏
        function updateChartsWithHistoricalData(data) {
            if (!data || data.length === 0) return;
            
            const recentData = data.slice(0, 168).reverse(); // 7 –¥–Ω–µ–π
            const labels = recentData.map(d => {
                const date = new Date(d.timestamp);
                return date.toLocaleDateString([], {month: 'short', day: 'numeric'}) + ' ' + 
                       date.toLocaleTimeString([], {hour: '2-digit'});
            });
            
            // PM2.5 Chart
            const pm25Ctx = document.getElementById('pm25Chart').getContext('2d');
            
            if (pm25Chart) {
                pm25Chart.destroy();
            }
            
            const pm25Data = recentData.map(d => d.pm25);
            
            pm25Chart = new Chart(pm25Ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'PM2.5 (¬µg/m¬≥)',
                        data: pm25Data,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true,
                        pointRadius: 3,
                        pointHoverRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '¬µg/m¬≥'
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
            
            // Temperature & Humidity Chart
            const tempHumCtx = document.getElementById('tempHumChart').getContext('2d');
            
            if (tempHumChart) {
                tempHumChart.destroy();
            }
            
            const tempData = recentData.map(d => d.temperature);
            const humData = recentData.map(d => d.humidity);
            
            tempHumChart = new Chart(tempHumCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Temperature (¬∞C)',
                            data: tempData,
                            borderColor: '#FF6384',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: true,
                            pointRadius: 3,
                            pointHoverRadius: 5,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Humidity (%)',
                            data: humData,
                            borderColor: '#36A2EB',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: false,
                            pointRadius: 3,
                            pointHoverRadius: 5,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                boxWidth: 6
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Temperature (¬∞C)'
                            },
                            grid: {
                                color: 'rgba(255,99,132,0.1)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Humidity (%)'
                            },
                            grid: {
                                drawOnChartArea: false
                            },
                            min: 0,
                            max: 100
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
        function refreshData() {
            loadHistoricalData();
            loadLongTermStats();
            updateProgress();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.innerHTML = '<i class="fas fa-sync-alt fa-spin me-2"></i>Refreshing data...';
            setTimeout(() => {
                statusMessage.innerHTML = '<i class="fas fa-check-circle text-success me-2"></i>Data refreshed';
            }, 1000);
        }

        // –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
        function exportData() {
            window.open('/api/export/last_7days', '_blank');
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
            updateDateTime();
            setInterval(updateDateTime, 1000);
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º WebSocket
            initWebSocket();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            loadHistoricalData();
            loadLongTermStats();
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä
            startCountdownTimer();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å Arduino
            fetch('/api/arduino/status')
                .then(response => response.json())
                .then(data => {
                    if (data.connected) {
                        updateConnectionStatus('connected', 'Connected to Arduino');
                    } else {
                        updateConnectionStatus('waiting', 'Waiting for Arduino connection...');
                    }
                })
                .catch(() => {
                    updateConnectionStatus('disconnected', 'Cannot connect to server');
                });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden) {
                    refreshData();
                }
            });
        });

        // –û—á–∏—Å—Ç–∫–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ –ø—Ä–∏ –≤—ã–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('beforeunload', function() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
        });
    </script>
</body>
</html>